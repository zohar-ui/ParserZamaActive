# AI Parser Integration Guide for n8n Workflow
## Schema v3.2 - Prescription vs Performance Separation

---

## ğŸ”„ Workflow Integration

### Current Flow:
```
prs_block â†’ Get session â†’ Block splitter â†’ Classify Structure â†’ block_id â†’ ...
```

### New Flow with AI Parser:
```
prs_block â†’ Get session â†’ Block splitter â†’ Classify Structure â†’ block_id 
    â†“
AI Parser Prompt Builder (NEW)
    â†“
HTTP Request to Claude API (NEW)
    â†“
AI Response Parser (NEW)
    â†“
Exercise Extractor (NEW)
    â†“
Validation (NEW)
    â†“
equipment1 â†’ ... (existing)
```

---

## ğŸ“¦ Nodes to Add

### Node 1: "AI Parser Prompt Builder" (Code Node)
**Position:** After "block_id" node
**Purpose:** Builds the prompt for Claude API

```javascript
// Copy from n8n_ai_parser_implementation.js - NODE 1
```

### Node 2: "Claude API Request" (HTTP Request Node)
**Position:** After "AI Parser Prompt Builder"
**Configuration:**

```
Method: POST
URL: https://api.anthropic.com/v1/messages
Authentication: Header Auth
  - Name: x-api-key
  - Value: {{$credentials.anthropicApi.apiKey}}
  - Name: anthropic-version
  - Value: 2023-06-01

Body (JSON):
{
  "model": "{{ $json.ai_model }}",
  "max_tokens": {{ $json.ai_max_tokens }},
  "system": "{{ $json.ai_system_prompt }}",
  "messages": [
    {
      "role": "user",
      "content": "{{ $json.ai_user_prompt }}"
    }
  ]
}
```

### Node 3: "AI Response Parser" (Code Node)
**Position:** After "Claude API Request"
**Purpose:** Parses Claude's response and extracts structured data

```javascript
// Copy from n8n_ai_parser_implementation.js - NODE 2
```

### Node 4: "Exercise Extractor" (Code Node)
**Position:** After "AI Response Parser"
**Purpose:** Converts parsed blocks into individual exercise rows

```javascript
// Copy from n8n_ai_parser_implementation.js - NODE 3
```

### Node 5: "Validation" (Code Node)
**Position:** After "Exercise Extractor"
**Purpose:** Validates parsed data

```javascript
// Copy from n8n_ai_parser_implementation.js - NODE 4
```

---

## ğŸ”Œ Alternative: No AI (JavaScript Only)

If you don't want to use AI API calls, use the JavaScript-only parser:

**Replace all 4 nodes above with single "JS Parser" Code Node:**

```javascript
// Copy parseWorkoutBlockJS function from n8n_ai_parser_implementation.js
```

---

## ğŸ“Š Schema v3.2 Output Structure

### Block Level:
```json
{
  "block_type": "strength|metcon|skill|warmup|accessory|circuit",
  "prescription_structure": "sets_reps|amrap|fortime|emom",
  "prescription_target_rounds": null,
  "prescription_target_duration": {"value": 10, "unit": "min"},
  "performed_did_complete": true,
  "performed_actual_rounds": 5,
  "performed_athlete_notes": "×”×™×” ×§×©×” ××‘×œ ×¡×™×™××ª×™"
}
```

### Exercise Level:
```json
{
  "exercise_name": "Back Squat",
  "exercise_schema": "5x5 @ 100kg",
  
  "rx_sets": 5,
  "rx_reps": 5,
  "rx_weight": {"value": 100, "unit": "kg"},
  "rx_duration": null,
  "rx_rest": {"value": 2, "unit": "min"},
  "rx_rpe_min": 7,
  "rx_rpe_max": 8,
  "rx_tempo": "3-0-1-0",
  
  "perf_sets": [
    {"set_index": 1, "reps": 5, "load": {"value": 100, "unit": "kg"}},
    {"set_index": 2, "reps": 5, "load": {"value": 100, "unit": "kg"}},
    {"set_index": 3, "reps": 4, "load": {"value": 100, "unit": "kg"}, "notes": "failed last rep"}
  ],
  
  "validation_passed": true,
  "needs_review": false
}
```

---

## ğŸŒ Hebrew Support

The parser automatically detects Hebrew text and interprets it as performance feedback:

**Input:**
```
B) Back Squat
5x5 @ 100kg
Rest 2-3 min
×”×™×” ×§×©×” ×‘×¡×˜ ×”××—×¨×•×Ÿ, ×”×¦×œ×—×ª×™ ×¨×§ 4 ×—×–×¨×•×ª
```

**Output:**
```json
{
  "prescription": {
    "exercises": [{
      "exercise_name": "Back Squat",
      "target_sets": 5,
      "target_reps": 5,
      "target_weight": {"value": 100, "unit": "kg"},
      "target_rest": {"value": 150, "unit": "sec"}
    }]
  },
  "performed": {
    "did_complete": false,
    "athlete_notes": "×”×™×” ×§×©×” ×‘×¡×˜ ×”××—×¨×•×Ÿ, ×”×¦×œ×—×ª×™ ×¨×§ 4 ×—×–×¨×•×ª",
    "exercises": [{
      "exercise_name": "Back Squat",
      "sets": [
        {"set_index": 1, "reps": 5, "load": {"value": 100, "unit": "kg"}},
        {"set_index": 2, "reps": 5, "load": {"value": 100, "unit": "kg"}},
        {"set_index": 3, "reps": 5, "load": {"value": 100, "unit": "kg"}},
        {"set_index": 4, "reps": 5, "load": {"value": 100, "unit": "kg"}},
        {"set_index": 5, "reps": 4, "load": {"value": 100, "unit": "kg"}, "notes": "last set - only 4 reps"}
      ]
    }]
  }
}
```

---

## âœ… Validation Rules

The validation agent checks:

1. **Number Consistency** - Every number in JSON appears in raw text
2. **Weight Limits** - Warn if > 500kg
3. **Rep Limits** - Warn if > 100 reps
4. **RPE Range** - Must be 1-10
5. **Hebrew Detection** - Ensure Hebrew notes captured as performance
6. **Exercise Names** - Must not be empty

---

## ğŸš€ Quick Start

1. Copy code from `n8n_ai_parser_implementation.js`
2. Add nodes to your workflow after "block_id"
3. Set up Anthropic API credentials in n8n
4. Test with sample workout data

---

## ğŸ“ Example Parsing

**Input Block:**
```
A) EMOM 20 Min:
Min 1: 5 Power Cleans @ 70kg
Min 2: 10 Box Jumps (24")
Min 3: 15 Wall Balls (9kg)
Min 4: Rest

×”×¨×’×©×ª×™ ××¢×•×œ×” ×”×™×•×, ×¡×™×™××ª×™ ××ª ×›×œ ×”×¡×˜×™×
```

**Output:**
```json
{
  "block_type": "metcon",
  "prescription": {
    "structure": "emom",
    "target_duration": {"value": 20, "unit": "min"},
    "exercises": [
      {"exercise_name": "Power Clean", "target_reps": 5, "target_weight": {"value": 70, "unit": "kg"}},
      {"exercise_name": "Box Jump", "target_reps": 10, "notes": "24 inch"},
      {"exercise_name": "Wall Ball", "target_reps": 15, "target_weight": {"value": 9, "unit": "kg"}},
      {"exercise_name": "Rest", "target_reps": null}
    ]
  },
  "performed": {
    "did_complete": true,
    "athlete_notes": "×”×¨×’×©×ª×™ ××¢×•×œ×” ×”×™×•×, ×¡×™×™××ª×™ ××ª ×›×œ ×”×¡×˜×™×"
  },
  "equipment_detected": ["Barbell", "Box", "Medicine Ball"]
}
```

---

**Last Updated:** January 26, 2026
**Schema Version:** 3.2.0
