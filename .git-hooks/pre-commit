#!/bin/bash
# ============================================
# Git Pre-Commit Hook: Schema Version Check
# ============================================
# Purpose: Prevent commits when schema doc and DB versions don't match
# Installation: ./scripts/install_hooks.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}ğŸ” Running pre-commit checks...${NC}"
echo ""

# ============================================
# 1. Schema Version Compatibility Check
# ============================================
echo -e "${YELLOW}[1/2]${NC} Checking schema version compatibility..."

if [ -f "./scripts/verify_schema_version.sh" ]; then
    # Run the verification script
    if ./scripts/verify_schema_version.sh; then
        echo -e "${GREEN}âœ“${NC} Schema version check passed"
    else
        EXIT_CODE=$?

        echo ""
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${RED}â•‘           âŒ COMMIT BLOCKED - Version Mismatch            â•‘${NC}"
        echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${YELLOW}Schema document version does not match database version.${NC}"
        echo ""
        echo -e "${YELLOW}Fix options:${NC}"
        echo -e "  1. Run migrations: ${BLUE}npx supabase db push${NC}"
        echo -e "  2. Update CANONICAL_JSON_SCHEMA.md to match DB version"
        echo -e "  3. Re-verify: ${BLUE}npm run verify:schema${NC}"
        echo ""
        echo -e "${RED}Commit rejected. Fix the version mismatch first.${NC}"
        echo ""

        # If DB is offline (exit code 0), allow commit with warning
        if [ $EXIT_CODE -eq 0 ]; then
            echo -e "${YELLOW}âš   Database offline - allowing commit with warning${NC}"
            echo ""
        else
            exit 1
        fi
    fi
else
    echo -e "${YELLOW}âš   Warning: verify_schema_version.sh not found, skipping check${NC}"
fi

echo ""

# ============================================
# 2. Check for Common Mistakes
# ============================================
echo -e "${YELLOW}[2/2]${NC} Checking for common mistakes..."

# Check if CANONICAL_JSON_SCHEMA.md was modified
if git diff --cached --name-only | grep -q "CANONICAL_JSON_SCHEMA.md"; then
    echo -e "${BLUE}â„¹  CANONICAL_JSON_SCHEMA.md was modified${NC}"

    # Check if YAML frontmatter has version
    if ! grep -q "^version:" docs/reference/CANONICAL_JSON_SCHEMA.md; then
        echo -e "${RED}âœ— ERROR: CANONICAL_JSON_SCHEMA.md missing 'version' in YAML frontmatter${NC}"
        echo -e "  Add version metadata at the top of the file:"
        echo -e "  ${BLUE}---${NC}"
        echo -e "  ${BLUE}version: \"3.2.0\"${NC}"
        echo -e "  ${BLUE}last_updated: \"$(date +%Y-%m-%d)\"${NC}"
        echo -e "  ${BLUE}---${NC}"
        exit 1
    fi

    echo -e "${GREEN}âœ“${NC} Schema has version metadata"
    echo ""
    echo -e "${YELLOW}ğŸ“‹ Reminder: If this is a version change, also:${NC}"
    echo -e "  1. Create migration: ${BLUE}npx supabase migration new update_schema_vX_Y${NC}"
    echo -e "  2. Update parser_rulesets in migration"
    echo -e "  3. Update CHANGELOG.md"
    echo ""
fi

# Check if migrations were added but not applied
MIGRATION_FILES=$(git diff --cached --name-only | grep "supabase/migrations/" | wc -l)
if [ "$MIGRATION_FILES" -gt 0 ]; then
    echo -e "${BLUE}â„¹  Migration files detected in commit${NC}"
    echo -e "${YELLOW}ğŸ“‹ Remember to apply migrations after pushing:${NC}"
    echo -e "  ${BLUE}npx supabase db push${NC}"
    echo ""
fi

echo -e "${GREEN}âœ“${NC} Pre-commit checks passed"
echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ All checks passed - proceeding with commit${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

exit 0
