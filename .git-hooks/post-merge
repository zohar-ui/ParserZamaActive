#!/bin/bash
# ============================================
# Git Post-Merge Hook: Auto-Update Documentation
# ============================================
# Purpose: Automatically update schema documentation after pulling migrations
# Installation: ./scripts/install_hooks.sh

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo -e "${BLUE}üîÑ Post-merge: Checking for schema changes...${NC}"
echo ""

# Check if any migration files changed
MIGRATION_CHANGES=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "supabase/migrations/" | wc -l)

if [ "$MIGRATION_CHANGES" -gt 0 ]; then
    echo -e "${YELLOW}üìã Detected $MIGRATION_CHANGES migration file(s) changed${NC}"
    echo -e "${BLUE}‚Üí Updating schema documentation...${NC}"
    echo ""

    # Check if database is accessible
    if [ -z "$SUPABASE_DB_URL" ]; then
        echo -e "${YELLOW}‚ö†  SUPABASE_DB_URL not set - skipping doc update${NC}"
        echo -e "  ${BLUE}Set SUPABASE_DB_URL to enable automatic updates${NC}"
        echo ""
        exit 0
    fi

    # Run the documentation updater
    if [ -f "scripts/docs/update_schema_docs.js" ]; then
        if npm run update-docs --silent; then
            echo ""
            echo -e "${GREEN}‚úì${NC} Schema documentation updated successfully"
            echo ""

            # Check if documentation actually changed
            if git diff --quiet docs/reference/VERIFIED_TABLE_NAMES.md; then
                echo -e "${BLUE}‚Ñπ  No schema changes detected (documentation unchanged)${NC}"
            else
                echo -e "${YELLOW}üìù Documentation changes detected:${NC}"
                echo -e "  ${BLUE}docs/reference/VERIFIED_TABLE_NAMES.md${NC}"
                echo ""
                echo -e "${YELLOW}Next steps:${NC}"
                echo -e "  1. Review changes: ${BLUE}git diff docs/reference/VERIFIED_TABLE_NAMES.md${NC}"
                echo -e "  2. Commit if accurate: ${BLUE}git add docs/reference/VERIFIED_TABLE_NAMES.md && git commit -m 'docs: update schema after migrations'${NC}"
            fi
        else
            echo ""
            echo -e "${YELLOW}‚ö†  Could not update documentation (database might be offline)${NC}"
            echo -e "  ${BLUE}Run manually: npm run update-docs${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†  Documentation updater script not found${NC}"
        echo -e "  ${BLUE}Expected: scripts/docs/update_schema_docs.js${NC}"
    fi
else
    echo -e "${BLUE}‚Ñπ  No migration changes detected - skipping doc update${NC}"
fi

echo ""
exit 0
